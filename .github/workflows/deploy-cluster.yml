name: Deploy ClickHouse Cluster

on:
  push:
    branches: [main]

jobs:
  deploy-cluster:
    name: Deploy Cluster with Rolling Updates
    runs-on: ubuntu-latest
    timeout-minutes: 90

    strategy:
      matrix:
        host:
          - name: clickhouse-keeper-1
            ip: 88.99.97.49
            beszel_agent_token_secret: CLICKHOUSE_KEEPER_1_BESZEL_AGENT_TOKEN
          - name: clickhouse-keeper-2
            ip: 138.201.137.181
            beszel_agent_token_secret: CLICKHOUSE_KEEPER_2_BESZEL_AGENT_TOKEN
          - name: clickhouse-keeper-3
            ip: 136.243.150.84
            beszel_agent_token_secret: CLICKHOUSE_KEEPER_3_BESZEL_AGENT_TOKEN
          - name: clickhouse-replica-1
            ip: 94.130.13.115
            beszel_agent_token_secret: CLICKHOUSE_REPLICA_1_BESZEL_AGENT_TOKEN
          - name: clickhouse-replica-2
            ip: 88.99.151.102
            beszel_agent_token_secret: CLICKHOUSE_REPLICA_2_BESZEL_AGENT_TOKEN
      max-parallel: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.HETZNER_BARE_METAL_GITHUB_ACTIONS_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ matrix.host.ip }} >> ~/.ssh/known_hosts

      - name: Test SSH connectivity
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no root@${{ matrix.host.ip }} "echo 'SSH connection successful'"

      - name: Copy docker-compose.yml to host
        run: |
          scp -i ~/.ssh/id_ed25519 ${{ matrix.host.name }}/docker-compose.yml root@${{ matrix.host.ip }}:/root/docker-compose.yml

      - name: Set file permissions
        run: |
          ssh -i ~/.ssh/id_ed25519 root@${{ matrix.host.ip }} "chmod 644 /root/docker-compose.yml"

      - name: Get current container status
        run: |
          echo "Getting current container status..."
          ssh -i ~/.ssh/id_ed25519 root@${{ matrix.host.ip }} "docker ps --all"

      - name: Deploy services with new configuration
        env:
          BESZEL_AGENT_TOKEN: ${{ secrets[matrix.host.beszel_agent_token_secret] }}
        run: |
          ssh -i ~/.ssh/id_ed25519 root@${{ matrix.host.ip }} "cd /root &&
          docker compose pull &&
          BESZEL_AGENT_TOKEN='${BESZEL_AGENT_TOKEN}' docker compose up --wait --force-recreate"

      - name: Verify services are running
        if: steps.check_changes.outputs.changed == 'true'
        env:
          BESZEL_AGENT_TOKEN: ${{ secrets[matrix.host.beszel_agent_token_secret] }}
        run: |
          echo "Verifying services are running..."
          ssh -i ~/.ssh/id_ed25519 root@${{ matrix.host.ip }} bash << EOF
          set -e
          cd /root
          export BESZEL_AGENT_TOKEN="${BESZEL_AGENT_TOKEN}"

          # Check if containers are running (without jq)
          RUNNING_CONTAINERS=\$(docker compose ps --filter "status=running" --format "{{.Name}}" | wc -l)
          TOTAL_CONTAINERS=\$(docker compose ps --format "{{.Name}}" | wc -l)

          echo "Running containers: \$RUNNING_CONTAINERS / \$TOTAL_CONTAINERS"

          if [ "\$RUNNING_CONTAINERS" -eq 0 ]; then
            echo "ERROR: No containers are running!"
            docker compose ps
            exit 1
          fi

          echo "Services verification successful"
          docker compose ps
          EOF
