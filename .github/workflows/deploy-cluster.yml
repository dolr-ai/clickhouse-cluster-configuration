name: Deploy ClickHouse Cluster

on:
  push:
    branches: [main]

jobs:
  deploy-cluster:
    name: Deploy Cluster with Rolling Updates
    runs-on: ubuntu-latest
    timeout-minutes: 90

    strategy:
      matrix:
        host:
          - name: clickhouse-keeper-1
            ip: 88.99.97.49
            beszel_agent_token_secret: CLICKHOUSE_KEEPER_1_BESZEL_AGENT_TOKEN
          - name: clickhouse-keeper-2
            ip: 138.201.137.181
            beszel_agent_token_secret: CLICKHOUSE_KEEPER_2_BESZEL_AGENT_TOKEN
          - name: clickhouse-keeper-3
            ip: 136.243.150.84
            beszel_agent_token_secret: CLICKHOUSE_KEEPER_3_BESZEL_AGENT_TOKEN
          - name: clickhouse-replica-1
            ip: 94.130.13.115
            beszel_agent_token_secret: CLICKHOUSE_REPLICA_1_BESZEL_AGENT_TOKEN
          - name: clickhouse-replica-2
            ip: 88.99.151.102
            beszel_agent_token_secret: CLICKHOUSE_REPLICA_2_BESZEL_AGENT_TOKEN
      max-parallel: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.HETZNER_BARE_METAL_GITHUB_ACTIONS_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ matrix.host.ip }} >> ~/.ssh/known_hosts

      - name: Test SSH connectivity
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no root@${{ matrix.host.ip }} "echo 'SSH connection successful'"

      - name: Copy hostname folder contents to host
        run: |
          scp -r -i ~/.ssh/id_ed25519 ${{ matrix.host.name }}/* root@${{ matrix.host.ip }}:/root/

      - name: Set file permissions
        run: |
          ssh -i ~/.ssh/id_ed25519 root@${{ matrix.host.ip }} "
          # Set proper ownership for ClickHouse data directories (ClickHouse runs as UID:GID 101:101)
          chown -R 101:101 /root/clickhouse/data /root/clickhouse/logs 2>/dev/null || true
          # Set directory permissions
          chmod -R 755 /root/clickhouse 2>/dev/null || true
          # Set config file permissions to read-only
          chmod 644 /root/docker-compose.yml 2>/dev/null || true
          chmod 644 /root/clickhouse/*.xml 2>/dev/null || true
          "

      - name: Get current container status
        run: |
          echo "Getting current container status..."
          ssh -i ~/.ssh/id_ed25519 root@${{ matrix.host.ip }} "docker ps --all"

      - name: Deploy services with new configuration
        env:
          BESZEL_AGENT_TOKEN: ${{ secrets[matrix.host.beszel_agent_token_secret] }}
          CLICKHOUSE_S3_STORAGE_SECRET_ACCESS_KEY: ${{ secrets.CLICKHOUSE_S3_STORAGE_SECRET_ACCESS_KEY }}
        run: |
          ssh -i ~/.ssh/id_ed25519 root@${{ matrix.host.ip }} "cd /root && \
          export BESZEL_AGENT_TOKEN='${BESZEL_AGENT_TOKEN}' && \
          export CLICKHOUSE_S3_STORAGE_SECRET_ACCESS_KEY='${CLICKHOUSE_S3_STORAGE_SECRET_ACCESS_KEY}' && \
          docker compose pull && \
          docker compose up --wait --force-recreate"
