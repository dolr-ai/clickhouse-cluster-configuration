---
- name: Deploy ClickHouse cluster configuration with rolling updates
  hosts: all
  serial: 1
  gather_facts: no
  vars:
    remote_user_home: "/root"
    docker_compose_path: "{{ remote_user_home }}/docker-compose.yml"
    health_check_retries: 30
    health_check_delay: 10

  tasks:
    - name: Display deployment start
      debug:
        msg: "Starting deployment for {{ inventory_hostname }}"

    - name: Ensure the target directory exists
      file:
        path: "{{ remote_user_home }}"
        state: directory
        mode: "0755"

    - name: Copy docker-compose.yml to host
      copy:
        src: "../../{{ inventory_hostname }}/docker-compose.yml"
        dest: "{{ docker_compose_path }}"
        owner: root
        group: root
        mode: "0644"
        backup: no
      register: compose_file_copied

    - name: Get current container information
      community.docker.docker_host_info:
        containers: yes
        containers_filters:
          label: "com.docker.compose.project={{ remote_user_home | basename }}"
      register: container_status_before
      failed_when: false
      changed_when: false

    - name: Display current status
      debug:
        msg: "Configuration {{ 'changed - will update services' if compose_file_copied.changed else 'unchanged - skipping update' }}"

    - name: Pull latest Docker images
      community.docker.docker_compose_v2:
        project_src: "{{ remote_user_home }}"
        files:
          - docker-compose.yml
        pull: yes
        state: present
      environment: "{{ host_env | default({}) }}"
      when: compose_file_copied.changed
      register: docker_pull_result

    - name: Deploy services with new configuration
      community.docker.docker_compose_v2:
        project_src: "{{ remote_user_home }}"
        files:
          - docker-compose.yml
        state: present
        restarted: yes
        recreate: yes
      environment: "{{ host_env | default({}) }}"
      when: compose_file_copied.changed
      register: docker_up_result

    - name: Wait for containers to stabilize
      pause:
        seconds: "{{ health_check_delay }}"
      when: compose_file_copied.changed

    - name: Verify services are running
      community.docker.docker_compose_v2:
        project_src: "{{ remote_user_home }}"
        files:
          - docker-compose.yml
        state: present
      environment: "{{ host_env | default({}) }}"
      register: compose_status
      changed_when: false

    - name: Get list of running containers
      community.docker.docker_host_info:
        containers: yes
        containers_filters:
          label: "com.docker.compose.project={{ remote_user_home | basename }}"
      register: running_containers
      changed_when: false
